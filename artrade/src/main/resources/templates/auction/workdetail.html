<!DOCTYPE html>
<html lang="ko"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/common_layout}"
      th:with="activeTab='workdetail', title='Welcome!'">
<head>
  <meta charset="utf-8">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
  <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css}" >
  <link rel="stylesheet" th:href="@{https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css}" >
  <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/bootstrap-social/5.1.1/bootstrap-social.css}" >
  <link rel="stylesheet" th:href="@{/css/member/login.css}" >


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>






  <title>작품 상세보기</title>
  <script>
    // 타이머
    timer = setInterval( function () {

      $.ajax ({
        type: 'GET',
        url : "/auction/computeAutionTime/[[${work.id}]]",
        dataType: 'json',
        success : function (result) {
          if(result.status === "notExistAuction"){
            $('#remain_price').html(result.result);
          }else{
            $('.days').html(result.days);
            $('.hours').html(result.hours);
            $('.minutes').html(result.minutes);
            $('.seconds').html(result.seconds);
          }
        }
      });
    }, 1000);

    // 좋아요 버튼 클릭시
    $(function(){
      $("#addlike").click(function(){
        $.ajax({
          url : "/work/like/[[${work.id}]]",
          type: 'GET',
          contentType: "application/json; charset=utf-8",
          dataType: 'json',
          success : function(result){
            $('#countLike').html(result.count);

          }
        })
      })
    });


  </script>
  <link rel="stylesheet" th:href="@{/css/work/workdetail.css}" >

  <style>
    .sidebar-section {
      position: absolute;
      height: 100%;
      width: 100%;
    }
    .sidebar-item {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .sidebar-icon{
      height: 50px;
      width: 50px;
      border: none;
      color: #eee;
      background: #fff;
    }
    .sidebar-icon.active{
      color:tomato;
    }
    .sidebar-icon:hover{
      color: tomato;
    }
    .auction-time{
      font-size: 30px;
      font-weight: 500;
    }
    .workInfoBx{
      display: flex;
      justify-content: center;
    }

  </style>

</head>
<body>
<section layout:fragment="content">
    <!-- 기본  Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div>
          <div class="text-center align-items-center mid ">
            <div class="modal-logo"><img src="https://imgur.com/N1vwiAJ.png"></div>
            <div class="modal-body pb-2">

            </div>
            <div class="modal-footer d-flex justify-content-center mb-3"> <button type="button" class="btn btn-block btn-outline-info" data-dismiss="modal" id="confirm" >확인</button> </div>
          </div>
        </div>
      </div>
    </div>

  <!-- 경매가 제안 Modal -->
  <div class="modal fade" id="auctionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div>
        <div class="text-center align-items-center mid">
          <div class="modal-logo"><img src="https://imgur.com/N1vwiAJ.png"></div>
          <div class="modal-body pb-2">

          </div>
          <div  class="pb-2" >
            <input type="number" class="form-control mt-2" placeholder="경매가 입력 (ex. 3ETH)" id="price">
          </div>
          <div class="modal-footer d-flex justify-content-center mb-3"> <button type="button" class="btn btn-block btn-outline-info" data-dismiss="modal" id="offer" >offer</button> </div>
        </div>
      </div>
    </div>
  </div>


  <!--경매 사진 및 가격제안-->

  <div class="container" >
    <div class="row workInfoBx">
      <div class="px-4">
        <img id="workpircture" th:src="${work.filePath}" style="border: 1px solid black; width: 300px; height: 300px;">
      </div>
      <div class="px-4">
        <h4 class="pt-3" id="workid" th:text="${work.title}" th:value="${work.id}">작품A</h4>
        <p>Masterpiece A</p>
        <p>created by 작가이름</p>
        <button class="sidebar-icon col-12 mt-2" id="addlike" sec:authorize="isAuthenticated()">
          <i class="fas fa-heart fa-2x"></i>
        </button>
        <span>인기도 :</span>
        <span class="textmuted" th:id= "countLike" th:text="${work.popularity}"></span>
        <div class="mb-4">
          <span class="fw-bold mt-3" id="remain_price"></span>
          현재 경매가 : &nbsp;
          <span class="ml-4" th:text="${work.auction.winingBid + ' &nbsp;ETH'}" th:id="priceSuggest" style="font-size:30px;"> 2ETH</span>
        </div>
        <!--        todo: sec:authorize 지우고 로직 맞게 쓰기 (if 구매자가 맞다면 버튼 보이기) -->
        <div class="btn btn-block btn-outline-info col-12" id="suggest">경매가제시하기 </div>
        <div sec:authorize="isAuthenticated()" class="btn btn-block btn-outline-info col-12" id="buy">구매하기 </div>
        <div class="col-12 mb-4 ">
        </div>
      </div>



    </div>
  </div>
    </div>

  </div>


  <!-- 클릭 시 좋아요 버튼 active 하는 스크립트 -->
<!--  <script>-->
<!--    function btnClick(){-->
<!--      const menuRed = document.querySelector('.sidebar-icon');-->
<!--      menuRed.classList.toggle('active');-->
<!--    }-->
<!--  </script>-->

  <div class="container py-md-0 py-3" id="timer" style = " margin-top:50px " >

    <!-- 작품 정보 및  가격 제안 -->
    <!--   <div id = "work-detail"> -->

    <!--타이머 -->


    <div class="row justify-content-center">
      <div class="col-lg-12 mb-30">

        <div class="rounded bg-faded  padding-top-3x padding-bottom-3x">
          <div class="text-center">
            <div class="countdown mb-3" data-date-time="12/30/2019 12:00:00">

              <h5>남은 경매 시간</h5>
              <div class="auction-time">
                <span class="days mx-1">00</span>
                <span class="hours mx-1">00</span>
                <span class="minutes mx-1">00</span>
                <span class="seconds mx-1">00</span>
              </div>
              <div>Days &nbsp; Hours &nbsp; Mins &nbsp; Secs</div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!--  표현식을 넣을 위치 -->
    <div class="card my-5">
      <div class="card-body">
        작품에 관한 설명이 이곳에 작성됩니다. 다음의 작품은 오픈마켓에서
        작품을 선택하였을 때 보이는 상세내용 입니다.
      </div>
    </div>


    <!--댓글 -->
    <script th:inline="javascript">
      $(document).ready(function() {

        $('#submit').click(function () {

          // 입력한 댓글 불러오기
          var data = {
            workNo: $("#bno").val(),
            comment: $("#comment-input").val(),
            count: $("#cnt").text()
          };


          console.log(data);
          console.log(JSON.stringify(data));

          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");

          // ajax 통신
          $.ajax({
            url: "/comment/add",  // 데이터 요청할 경로 지정
            type: "POST",                   // 방식 : POSt
            data: JSON.stringify(data),     // JSON 데이터를 string화 시킴


            beforeSend : function(xhr)
            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
              xhr.setRequestHeader(header, token);
            },
            contentType: "application/json; charset=utf-8",
            dataType:'json',
            success: function (data) {
              console.log(data)
              // if(data == 1){
              //   getCommentList()
              //   $('#comment-input').val('');
              // }
              // $("#comments-contents").html(data.comment);
              // $("#comments-nickName").html(data.nickName);
              // $("#comments-time").html(data.time);
              $("#cnt").html(data.cnt);
              getCommentList(data);
            },
          });
        });

      });

      // 댓글을 html 형식 세트로 보내기
      var html = "";
      function getCommentList(data) {


              $(data).each(function () {
                html += '<label name = "comment">'
                html += '<i class="fas fa-user"></i>'
                html += '</label>'
                html += '<div id = "comments-nickName">'
                html +=  data.nickName
                html += '</div>'
                html += '<div id = "comments-contents" >'
                html +=  data.comment
                html += '</div>'
                html += '<div id = "comments-time">'
                html += data.time
                html += '</div>'
              });

        $("#comments").html(html);

      }


    </script >





<!--    <script th:inline="javascript">-->
<!--      $(document).ready(function() {-->

<!--        $('#submit').click(function () {-->

<!--          // 입력한 댓글 불러오기-->
<!--          var data = {-->
<!--            workNo: $("#bno").val(),-->
<!--            comment: $("#comment-input").val(),-->
<!--            count: $("#cnt").text()-->
<!--          };-->


<!--          console.log(data);-->
<!--          console.log(JSON.stringify(data));-->

<!--          var token = $("meta[name='_csrf']").attr("content");-->
<!--          var header = $("meta[name='_csrf_header']").attr("content");-->

<!--          // ajax 통신-->
<!--          $.ajax({-->
<!--            url: "/comment/add",  // 데이터 요청할 경로 지정-->
<!--            type: "POST",                   // 방식 : POSt-->
<!--            data: JSON.stringify(data),     // JSON 데이터를 string화 시킴-->


<!--            beforeSend : function(xhr)-->
<!--            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/-->
<!--              xhr.setRequestHeader(header, token);-->
<!--            },-->
<!--            contentType: "application/json; charset=utf-8",-->
<!--            dataType:'json',-->
<!--            success: function (data) {-->
<!--              console.log(data)-->
<!--              if(data == 1){-->
<!--                getCommentList()-->
<!--                $('#comment-input').val('');-->
<!--              }-->
<!--              // $("#comments-contents").html(data.comment);-->
<!--              // $("#comments-nickName").html(data.nickName);-->
<!--              // $("#comments-time").html(data.time);-->
<!--              // $("#cnt").html(data.cnt);-->
<!--              // getCommentList(data);-->
<!--            },-->
<!--          });-->
<!--        });-->

<!--      });-->

<!--      // 댓글을 html 형식 세트로 보내기-->
<!--      var html = "";-->
<!--      function getCommentList() {-->

<!--        var data = {-->
<!--          workNo: $("#bno").val(),-->
<!--        };-->

<!--        $.ajax({-->
<!--          url: "/comment/list",-->
<!--          type: "GET",                   // 방식 : POSt-->
<!--          data: JSON.stringify(data),     // JSON 데이터를 string화 시킴-->
<!--          contentType: "application/json; charset=utf-8",-->
<!--          dataType: 'json',-->
<!--          success: function (data) {-->
<!--            var cCnt = data.cnt;-->
<!--            if (cCnt == 0) {-->
<!--              html = '<div>등록된 댓글이 없습니다.</div>'-->
<!--            } else {-->

<!--              $(data).each(function () {-->
<!--                html += '<label name = "comment">'-->
<!--                html += '<i class="fas fa-user"></i>'-->
<!--                html += '</label>'-->
<!--                html += '<div id = "comments-nickName">'-->
<!--                html += data.comment-->
<!--                html += '</div>'-->
<!--                html += '<div id = "comments-contents" >'-->
<!--                html += data.nickName-->
<!--                html += '</div>'-->
<!--                html += '<div id = "comments-time">'-->
<!--                html += data.time-->
<!--                html += '</div>'-->
<!--              });-->
<!--            }-->
<!--            $("#comments").html(html);-->

<!--          }-->
<!--        })-->
<!--      }-->
<!--    </script >-->

    <!--    <script>-->
    <!--      var bno = '${detail.bno}'; //게시글 번호-->

    <!--      $('[name=commentInsertBtn]').click(function(){ //댓글 등록 버튼 클릭시-->
    <!--        var insertData = $('[name=commentInsertForm]').serialize(); //commentInsertForm의 내용을 가져옴-->
    <!--        commentInsert(insertData); //Insert 함수호출(아래)-->
    <!--      });-->



    <!--      //댓글 목록-->
    <!--      function commentList(){-->
    <!--        $.ajax({-->
    <!--          url : '/comment/list',-->
    <!--          type : 'get',-->
    <!--          data : {'bno':bno},-->
    <!--          success : function(data){-->
    <!--            var a ='';-->
    <!--            $.each(data, function(key, value){-->
    <!--              a += '<div class="commentArea" style="border-bottom:1px solid darkgray; margin-bottom: 15px;">';-->
    <!--              a += '<div class="commentInfo'+value.cno+'">'+'댓글번호 : '+value.cno+' / 작성자 : '+value.writer;-->
    <!--              a += '<a onclick="commentUpdate('+value.cno+',\''+value.content+'\');"> 수정 </a>';-->
    <!--              a += '<a onclick="commentDelete('+value.cno+');"> 삭제 </a> </div>';-->
    <!--              a += '<div class="commentContent'+value.cno+'"> <p> 내용 : '+value.content +'</p>';-->
    <!--              a += '</div></div>';-->
    <!--            });-->

    <!--            $(".commentList").html(a);-->
    <!--          }-->
    <!--        });-->
    <!--      }-->

    <!--      //댓글 등록-->
    <!--      function commentInsert(insertData){-->
    <!--        $.ajax({-->
    <!--          url : '/comment/insert',-->
    <!--          type : 'post',-->
    <!--          data : insertData,-->
    <!--          success : function(data){-->
    <!--            if(data == 1) {-->
    <!--              commentList(); //댓글 작성 후 댓글 목록 reload-->
    <!--              $('[name=content]').val('');-->
    <!--            }-->
    <!--          }-->
    <!--        });-->
    <!--      }-->

    <!--      //댓글 수정 - 댓글 내용 출력을 input 폼으로 변경-->
    <!--      function commentUpdate(cno, content){-->
    <!--        var a ='';-->

    <!--        a += '<div class="input-group">';-->
    <!--        a += '<input type="text" class="form-control" name="content_'+cno+'" value="'+content+'"/>';-->
    <!--        a += '<span class="input-group-btn"><button class="btn btn-default" type="button" onclick="commentUpdateProc('+cno+');">수정</button> </span>';-->
    <!--        a += '</div>';-->

    <!--        $('.commentContent'+cno).html(a);-->

    <!--      }-->

    <!--      //댓글 수정-->
    <!--      function commentUpdateProc(cno){-->
    <!--        var updateContent = $('[name=content_'+cno+']').val();-->

    <!--        $.ajax({-->
    <!--          url : '/comment/update',-->
    <!--          type : 'post',-->
    <!--          data : {'content' : updateContent, 'cno' : cno},-->
    <!--          success : function(data){-->
    <!--            if(data == 1) commentList(bno); //댓글 수정후 목록 출력-->
    <!--          }-->
    <!--        });-->
    <!--      }-->

    <!--      //댓글 삭제-->
    <!--      function commentDelete(cno){-->
    <!--        $.ajax({-->
    <!--          url : '/comment/delete/'+cno,-->
    <!--          type : 'post',-->
    <!--          success : function(data){-->
    <!--            if(data == 1) commentList(bno); //댓글 삭제후 목록 출력-->
    <!--          }-->
    <!--        });-->
    <!--      }-->




    <!--      $(document).ready(function(){-->
    <!--        commentList(); //페이지 로딩시 댓글 목록 출력-->
    <!--      });-->
    <!--    </script>-->


    <!-- 댓글 테스트 중 -->
    <!--    <div class="container">-->
    <!--      <label for="content">comment</label>-->
    <!--      <form name="commentInsertForm">-->
    <!--        <div class="input-group">-->
    <!--          <input type="hidden" name="bno" th:text="${work.id}"/>-->
    <!--          <input type="text" class="form-control" id="content" name="content" placeholder="내용을 입력하세요.">-->
    <!--          <span class="input-group-btn">-->
    <!--                    <button class="btn btn-default" type="button" name="commentInsertBtn">등록</button>-->
    <!--               </span>-->
    <!--        </div>-->
    <!--      </form>-->
    <!--    </div>-->

    <!--    <div class="container">-->
    <!--      <div class="commentList"></div>-->
    <!--    </div>-->
    <!--  </div>-->




      <div>
          <input type="hidden" id="bno" th:value="${work.id}">
      </div>
      <div id="comment-count" class = "replyCount">댓글 <span  id="cnt" >0</span></div>
      <div class ="card replyList"  id = "comments">
      </div>

      <!-- 댓글 달 창 -->
      <div class = "container-comment">
          <label name = "comment"><i class="fas fa-user"></i></label>
          <div id="form-commentInfo" >
              <input type = "text" id="comment-input" placeholder="댓글을 입력해 주세요.">
              <input type = "submit" id = "submit" class="btn float-right" value="댓글 작성">


    <!-- 최근 본 작품들 -->
    <div id = "recent-work">

      <h4>보고 있는 작품과 비슷한 작품</h4>

      <div class="col-lg-4 col-md-6 col-sm-10 offset-md-0 offset-sm-1">
        <div class="card"> <img class="card-img-top" src="https://www.freepnglogos.com/uploads/cucumber-png/cucumber-png-image-purepng-transparent-png-26.png">
          <div class="card-body">
            <div class="d-flex align-items-center product"> <span class="fas fa-star"></span> <span class="fas fa-star"></span> <span class="fas fa-star"></span> <span class="fas fa-star"></span> <span class="far fa-star"></span> </div>
            <div class="d-flex align-items-center justify-content-between pt-3">
              <div class="d-flex flex-column">
                <div class="h6 font-weight-bold">작품A</div>
              </div>
              <div class="h6 font-weight-bold">2ETH</div>
            </div>
          </div>
        </div>
      </div>


    </div>
    <!--  </div>  -->





  </div>

  </div>
</div>


  <div layout:fragment="script">
    <script th:src="@{/js/work/workdetail.js}"></script>
    <script>

      let index= {
        init: function () {
          $("#offer").on("click", () => { //function(){}, ()=>{}this를 바인딩하기 위해
            this.save();
          });
        },
        save:function (){
          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");
          let data = {
            offerPrice: $("#price").val()
          };
          console.log(data); // 자바스크립트 오브젝트
          console.log(JSON.stringify(data));
          $.ajax({
            type: "POST",
            url: "/auction/suggest/detail/[[${work.id}]]",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            beforeSend : function(xhr)
            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
              xhr.setRequestHeader(header, token);
            },
          }).done(function (resp) {
            $('#priceSuggest').html(resp.maxPrice);
            $('.modal-body').html(resp.status);
            $('#exampleModal').modal();
          }).fail(function (error) {
            alert(JSON.stringify(error));
          });


        }




      }
      index.init();


    </script>

  </div>
</section>
</body>
</html>